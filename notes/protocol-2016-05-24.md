# Protocol 2015-05-24
---

# OpenHAB + Enocean

Goals:
* Light up a LED when pressing a wireless connected enocean button via OpenHAB. 
* Show the temperature of a enocean sensor on the openHAB website. 

# Wiring

The PI will be connected with the enocean receiver with the serial cable. Connect the cables on the receiver like this:
![Wiring Receiver](http://www.kerrywong.com/blog/wp-content/uploads/2014/08/EnOceanSensorsTransceiverPinout.jpg)

On the PI connect the RX from the receiver at the TX port and vice versa. Use 3.3V power supply.

# Basic Setup

Sources: 
* https://www.element14.com/community/community/design-challenges/forget-me-not/blog/2014/08/10/ip-post-5-tutorial-for-interfacing-openhab-with-enocean-pi
* https://github.com/openhab/openhab/wiki/EnOcean-Binding

The port in use is **/dev/ttyAMA0**

Disable Serial Port logging. Edit the file ```/etc/inittab``` that it looks like this (I have commented out the second line):
    
    #Spawn a getty on Raspberry Pi serial line
    #T0:23:respawn:/sbin/getty -L ttyAMA0 115200 vt100


Next open ```/boot/cmdline.txt``` and remove any ttyAMA0 reference:

Before:

    dwc_otg.lpm_enable=0 console=ttyAMA0,115200 kgdboc=ttyAMA0,115200 console=tty1 elevator=deadline root=/dev/mmcblk0p2 rootfstype=ext4 fsck.repair=yes rootwait

After:

    dwc_otg.lpm_enable=0 console=tty1 elevator=deadline root=/dev/mmcblk0p2 rootfstype=ext4 fsck.repair=yes rootwait


Go to *openhab.cfg* (and to be sure also to *openhab_default.cfg*) and look for the enocean bindings (for me it was in line 1286) and write the following:

    enocean:serialPort=/dev/ttyAMA0
    
**Pitfall**: I edited the *openhab.cfg* according to a tutorial, but that didn't work. So I edited both files. I think only the *openhab_default.cfg* would also work.

Good we're not finished yet. Now we need to add the bindings (JAR file) to the addons so that openHAB can speak enocean. Copy the *org.openhab.binding.enocean-1.8.2.jar* file into the ```/opt/openhab/addons/``` folder.

Finally last file to edit is the *start.sh* (and the same for the *start_debug.sh* if you want to debug enocean like we did). Add this line before the *-jar ...* line (third last line):

    -Dgnu.io.rxtx.SerialPorts=/dev/ttyAMA0 \
    
Now **restart the PI** and enocean should work.

# Light up the LED and show temperature

Add the following code to the items file:

    Switch EnButton () {enocean="{id=00:29:47:9A, eep=F6:02:01, channel=B}"}
    Number Temperature "Temperature [%.1f Â°C]" <temperature> (All) {enocean="{id=01:81:B9:B6, eep=A5:02:05, parameter=TEMPERATURE}"}
    
Important Enocean properties:
* ID: The device ID, either printed on the device or shown in debug output
* EEP: Enocean Equipment Protocol, defines what kind of device it is. E.g. Button, Temperature sensor and what kind of protocol it uses for sending data.
* Others are protocol specific

Add the following to the sitemap file:

     Frame label="EnOcean"
     {
       Text item=Temperature valuecolor=[>25="orange",>15="green",>5="orange",<=5="blue"]
     }
     
This will display the temperature in a color that represents the temperature value.

Finally there needs to be a rule that triggers when the button changes:

    rule "turn LED on with enocean button"
    when
            Item EnButton received command ON
    then
            MyLED1.sendCommand(ON)
    end
    rule "turn LED OFF with onocean button"
    when
            Item EnButton received command OFF
    then
            MyLED1.sendCommand(OFF)
    end

Pitfall: One side of the button (e.g. O) always send ON when pressed and released. Therefore we need to seperate rules instead of only one.

# OpenHAB + Philips HUE
To be written...